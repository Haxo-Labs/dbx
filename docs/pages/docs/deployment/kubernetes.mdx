# Kubernetes Deployment

This guide covers deploying DBX on Kubernetes clusters for production environments.

## Prerequisites

- Kubernetes cluster (1.20+)
- kubectl configured
- Helm (optional, for easier deployment)

## Basic Deployment

### Using kubectl

Create a namespace:

```bash
kubectl create namespace dbx
```

Deploy DBX:

```bash
kubectl apply -f k8s/deployment.yaml
kubectl apply -f k8s/service.yaml
```

### Using Helm

Add the Helm repository:

```bash
helm repo add dbx https://effortlesslabs.github.io/dbx
helm repo update
```

Install DBX:

```bash
helm install dbx dbx/dbx --namespace dbx --create-namespace
```

## Configuration

### Environment Variables

```yaml
env:
  - name: DBX_DATABASE_URL
    value: "redis://redis:6379"
  - name: DBX_JWT_SECRET
    valueFrom:
      secretKeyRef:
        name: dbx-secrets
        key: jwt-secret
  - name: DBX_LOG_LEVEL
    value: "info"
```

### ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: dbx-config
data:
  config.toml: |
    [server]
    host = "0.0.0.0"
    port = 8080

    [database]
    url = "redis://redis:6379"

    [auth]
    jwt_secret = "your-secret-key"
```

### Secrets

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: dbx-secrets
type: Opaque
data:
  jwt-secret: <base64-encoded-secret>
```

## Deployment Examples

### Basic Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dbx
  namespace: dbx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: dbx
  template:
    metadata:
      labels:
        app: dbx
    spec:
      containers:
        - name: dbx
          image: effortlesslabs/dbx:latest
          ports:
            - containerPort: 8080
          env:
            - name: DBX_DATABASE_URL
              value: "redis://redis:6379"
          resources:
            requests:
              memory: "64Mi"
              cpu: "250m"
            limits:
              memory: "128Mi"
              cpu: "500m"
```

### Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: dbx-service
  namespace: dbx
spec:
  selector:
    app: dbx
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: ClusterIP
```

### Ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dbx-ingress
  namespace: dbx
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
    - host: dbx.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: dbx-service
                port:
                  number: 80
```

## Scaling

### Horizontal Pod Autoscaler

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: dbx-hpa
  namespace: dbx
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: dbx
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
```

## Monitoring

### ServiceMonitor (Prometheus)

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: dbx-monitor
  namespace: dbx
spec:
  selector:
    matchLabels:
      app: dbx
  endpoints:
    - port: metrics
      interval: 30s
```

### PodDisruptionBudget

```yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: dbx-pdb
  namespace: dbx
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: dbx
```

## Best Practices

1. **Resource Limits**: Always set resource requests and limits
2. **Health Checks**: Implement liveness and readiness probes
3. **Secrets Management**: Use Kubernetes secrets for sensitive data
4. **Monitoring**: Set up proper monitoring and alerting
5. **Backup**: Implement regular backup strategies
6. **Security**: Use network policies to restrict traffic

## Troubleshooting

### Check Pod Status

```bash
kubectl get pods -n dbx
kubectl describe pod <pod-name> -n dbx
```

### View Logs

```bash
kubectl logs <pod-name> -n dbx
kubectl logs -f <pod-name> -n dbx
```

### Port Forward

```bash
kubectl port-forward <pod-name> 8080:8080 -n dbx
```
